#!/bin/sh
echo "initrd: alive"

sls_log() {
	printf -- "- \e[94m$*\e[0m\n"
}

cleanup() {
    exit_code=$?
    if [ $exit_code -ne 0 ]; then
		printf -- "- \e[91mcommand failed with status $exit_code\e[0m"
		sls_log "dropping into emergency shell"
        exec /bin/sh -i
    fi
}

trap cleanup EXIT
set -ue

# mounts
sls_log "mount /dev"
mount -t devtmpfs none /dev
sls_log "mount /proc"
mount -t proc proc /proc
sls_log "mount /sys"
mount -t sysfs sysfs /sys

# read params
for arg in $(cat /proc/cmdline); do
	case "$arg" in
		root=*)
			rootdisk="${arg#root=}"
			;;
		rootfstype=*)
			rootfstype="${arg#rootfstype=}"
			;;
		init=*)
			init="${arg#init=}"
			;;
	esac
done

# if live, then locate the livecd (awful hack)
if grep -qw live /proc/cmdline; then
	while [ -z "${rootdisk:-}" ]; do
		for dev in /sys/class/block/*; do
			devpath="/dev/${dev##*/}"
			if dd if=$devpath bs=1024 count=64 2>/dev/null | strings | grep -qw "SLS_LINUX_ISO"; then
				sls_log "found livecd root: $devpath"
				rootdisk=$devpath
				break
			fi
		done
	done
	sleep 1
fi

# mount root
sls_log "mount /mnt"
mount -t ${rootfstype:-iso9660} -o ro ${rootdisk:-/dev/sr0} /mnt

if grep -qw ro /proc/cmdline; then
	# read-only disk, use /tmp
	ROOT="/tmp"

	sls_log "mount $ROOT"
	mount -t tmpfs tmpfs $ROOT

	sls_log "copy root to $ROOT"
	cd /mnt && tar cf - . | (cd /tmp && tar xpf -) && cd /

	sls_log "unmount /mnt"
	umount /mnt
else
	# read-write, use the actual disk
	ROOT="/mnt"
	sls_log "remount /mnt as rw"
	mount -o remount,rw /mnt
fi

# move mountpoints
sls_log "move /dev to $ROOT/dev"
mount -M /dev $ROOT/dev
sls_log "move /proc to $ROOT/proc"
mount -M /proc $ROOT/proc
sls_log "move /sys to $ROOT/sys"
mount -M /sys $ROOT/sys
sls_log "mount $ROOT/tmp"
mount -t tmpfs tmpfs $ROOT/tmp
sls_log "mount $ROOT/dev/pts"
# TODO: figure out why the fuck we have to mkdir here
mkdir $ROOT/dev/pts
mount -t devpts devpts $ROOT/dev/pts

# switch_root
sls_log "running switch_root"
exec switch_root $ROOT ${init:-/bin/sinit}
