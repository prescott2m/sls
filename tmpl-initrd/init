#!/bin/sh
echo "initrd: alive"

sl_log() {
	echo "- \e[94m$*\e[0m"
}

sl_log "mount /dev"
mount -t devtmpfs none /dev
sl_log "mount /proc"
mount -t proc proc /proc

for arg in $(cat /proc/cmdline); do
	case "$arg" in
		rootdisk=*)
			rootdisk="${arg#root=}"
			;;
		rootfstype=*)
			rootfstype="${arg#rootfstype=}"
			;;
		init=*)
			init="${arg#init=}"
			;;
	esac
done

sl_log "mount /mnt"
mount -t ${rootfstype:-iso9660} -o ro ${rootdisk:-/dev/sr0} /mnt

if grep -qw ro /proc/cmdline; then
	# read-only disk, use /tmp
	ROOT="/tmp"

	sl_log "mount $ROOT"
	mount -t tmpfs tmpfs $ROOT

	sl_log "copy root to $ROOT"
	cd /mnt && tar cf - . | (cd /tmp && tar xpf -) && cd /

	sl_log "unmount /mnt"
	umount /mnt
else
	# read-write, use the actual disk
	ROOT="/mnt"
	sl_log "remount /mnt as rw"
	mount -o remount,rw /mnt
fi

sl_log "move /dev to $ROOT/dev"
mount -M /dev $ROOT/dev
sl_log "move /proc to $ROOT/proc"
mount -M /proc $ROOT/proc
sl_log "mount $ROOT/sys"
mount -t sysfs sysfs $ROOT/sys

sl_log "running switch_root"
exec switch_root $ROOT ${init:-/bin/sinit}